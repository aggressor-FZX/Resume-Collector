name: Sync Resume Training Data

on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 8am UTC
  workflow_dispatch:
  repository_dispatch:
    types: [resume-api-update]

jobs:
  sync-and-format:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Resume-Collector
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci || true

      - name: Fetch from Resume API
        env:
          RESUME_API_KEY: ${{ secrets.RESUME_API_KEY }}
          RESUME_API_URL: ${{ vars.RESUME_API_URL }}
        run: |
          mkdir -p training-data/raw
          curl -s -H "Authorization: Bearer $RESUME_API_KEY" \
               -H "Accept: application/json" \
               "$RESUME_API_URL/batch?limit=100" \
               -o training-data/raw/resumes-$(date +%Y%m%d).json || exit 0

      - name: Set DATE_FILE
        run: echo "DATE_FILE=$(date +%Y%m%d)" >> $GITHUB_ENV

      - name: Format for LLM Fine-Tuning (TypeScript)
        run: |
          npx ts-node scripts/format-for-llm.ts \
            --input training-data/raw/resumes-${{ env.DATE_FILE }}.json \
            --output training-data/formatted/resumes-${{ env.DATE_FILE }}.jsonl \
            --format openai || echo "No input found or no resumes to format"

      - name: Run tests
        run: |
          npm test --silent || true

      - name: Validate JSONL
        run: |
          if [ -f "training-data/formatted/resumes-${DATE_FILE}.jsonl" ]; then
            python3 -c "
import sys,json
import os
p = os.environ.get('DATE_FILE_PATH', 'training-data/formatted/resumes-${DATE_FILE}.jsonl')
with open(p,'r') as f:
    for i,line in enumerate(f,1):
        try:
            json.loads(line)
        except Exception as e:
            print(f'Invalid JSONL at line {i}: {e}')
            sys.exit(1)
print('âœ… JSONL validation passed')
"
          else
            echo "No formatted file to validate"
          fi

      - name: Update Latest Symlink
        run: |
          cd training-data/formatted || exit 0
          if [ -f resumes-${DATE_FILE}.jsonl ]; then
            ln -sf resumes-$(date +%Y%m%d).jsonl latest.jsonl || true
          fi

      - name: Commit & Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add training-data/ || true
          git commit -m "chore: sync $(date +%Y-%m-%d) training data" || echo "No changes"
          git push || echo "Push failed"
